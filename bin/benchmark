#!/bin/bash

set -e

DIR=$( cd $(dirname "${BASH_SOURCE[0]}") && pwd )
cd "$DIR/.."

THREADS=8
GAMES=200

if [ $1 == "9" ]; then
    TIME="5m"
elif [ $1 == "13" ]; then
    TIME="10m"
elif [ $1 == "19" ]; then
    TIME="20m"
else
    echo "Size '$1' isn't supported!"
    exit 1
fi

SIZE=$1

if [ -z "$2" ]; then
    PREFIX=`git rev-parse --short HEAD`
else
    PREFIX=$2
fi

FN="$PREFIX-${SIZE}x${SIZE}"

set -x

if [ ! -f "${FN}.html" ]; then
    cargo clean
    cargo build --release

    GNUGO="gnugo --mode gtp --level 0 --chinese-rules --positional-superko --capture-all-dead --score aftermath --play-out-aftermath"
    IOMRASCALAI="./target/release/iomrascalai -r chinese -t $THREADS -l"
    REFEREE="$GNUGO"

    gogui-twogtp -auto -black "$GNUGO" -white "$IOMRASCALAI" \
                 -size $SIZE -alternate -games $GAMES -sgffile $FN \
                 -time $TIME -referee "$REFEREE" -verbose -debugtocomment
    rm -f $FN.html
    gogui-twogtp -analyze $FN.dat

fi
